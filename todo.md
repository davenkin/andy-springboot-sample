- Mongo
  - 不用spring的repository
  - 启用transaction
  - 使用mongock，命名规范
- ShedLock
  - 直接用于定时任务
  - LockingTaskExecutor可以直接调用
- CommandService
  - 需要将Principal传进去，从CommandService以后就不要再依赖ThreadLocal来获取Spring Security中的用户信息了
  - 门面，标定一次用例，不应该只为HTTP的controller服务
- HTTP请求处理流程
  - 写数据请求，command service是门面，是业务用例的入口，然后通过repository加载聚合根对象，调用聚合根对象上的业务方法，再通过repository保存聚合根
  - 读数据请求
  - command，query，response使用record表示
- 异常处理
- 缓存
- 为基础设施添加测试
- 优先使用record
- 由于测试运行时没有启动redis，因此在引入新的缓存对象时，请在本地运行保证缓存能够正常地工作，比如缓存是否生效以及序列化/反序列化是否正常工作，通过在BaseTest中启用local profile可以完成测试
- ar的id需要全局唯一，不能在tenant下唯一，可以直接通过id定位到一个ar，而不用必须传入tenantId，当然在业务上需要tenantId来界定时，比如同时传入id和tenantId
- 接收请求时，我们需要保证tenant是可信的，即：
  - 如果是root用户，可以通过http的header传入tenantId
  - 如果是tenant下的用户，那么必须从JWT中获取tenantId
- WebClient：1，使用当前用户的jwt，2，使用service account